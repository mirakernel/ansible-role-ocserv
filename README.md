# Openconnect Server ansible role

Эта роль позволяет развернуть и настроить OpenConnect Server (ocserv) на Debian с поддержкой OpenID Connect (OIDC) для аутентификации, а также с возможностью объявления видимых маршрутов для VPN-пользователей.

## Особенности

- **Аутентификация через OIDC**: Интеграция с провайдерами, поддерживающими OpenID Connect (например, Google, Keycloak и др.).
- **VPN-конфигурация**: Настройка подсети для VPN-клиентов, указание маски сети и портов (TCP/UDP).
- **Объявление маршрутов**: Возможность анонсировать подсети (visible routes), чтобы VPN-пользователи могли видеть и получать доступ к внутренним ресурсам.
- **NAT и IP-пересылка**: Автоматическая настройка iptables для маскарадинга VPN-подсети и включение IP-пересылки на сервере.

## Переменные

Все параметры, необходимые для настройки, определяются в файле `defaults/main.yml`:

- **OIDC настройки:**
  - `ocserv_oidc_url`: URL для получения конфигурации OIDC (например, `https://your-idp.com/.well-known/openid-configuration`).
  - `ocserv_oidc_client_id`: Идентификатор клиента для OIDC.
  - `ocserv_oidc_client_secret`: Секрет клиента для OIDC.
  - `ocserv_oidc_redirect_uri`: URI перенаправления для OIDC (например, `https://your-vpn-server.com/redirect`).

- **Настройки VPN:**
  - `ocserv_vpn_subnet`: Подсеть для VPN-клиентов (например, `192.168.100.0/24`).
  - `ocserv_ipv4_netmask`: Маска подсети (например, `255.255.255.0`).
  - `ocserv_network_interface`: Сетевой интерфейс для NAT (например, `eth0`).

- **Объявляемые маршруты:**
  - `ocserv_visible_routes`: Список подсетей, которые будут анонсированы клиентам (например, `["192.168.1.0/24"]`).

## Использование роли

1. **Создайте playbook**

   Пример файла `vpn_setup.yml`:

   ```yaml
   - hosts: vpn_servers
     become: yes
     roles:
       - ocserv
   ```

2. **Запустите playbook**

   Выполните команду:

   ```bash
   ansible-playbook vpn_setup.yml
   ```

## Настройка ocserv

Конфигурация ocserv разворачивается с использованием шаблона `templates/ocserv.conf.j2`, который включает:

- Настройки OIDC (параметры аутентификации через OpenID Connect).
- Основные сетевые параметры (подсеть VPN, маска, TCP/UDP порты).
- Директивы `route` для видимых подсетей, определённых в переменной `ocserv_visible_routes`.

## Требования

- Debian или производные (например, Ubuntu).
- Ansible версии 2.9 или выше.
- Доступ с правами root или возможность использовать sudo.

## Примечания

- Проверьте, что значение переменной `ocserv_network_interface` соответствует интерфейсу, через который сервер подключен к локальной сети.
- При необходимости внесите дополнительные изменения в шаблон `ocserv.conf.j2` или добавьте новые задачи для расширенной настройки.
- Рекомендуется протестировать настройки в тестовом окружении перед развертыванием в продакшене.
